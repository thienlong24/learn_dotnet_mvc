@using System.Text.Json
@model MvcMovie.Models.Movie

@{
    ViewData["Title"] = "Import Movies";
    var importFailures = TempData["ImportFailures"] != null 
        ? JsonSerializer.Deserialize<List<(int RowNumber, string Title, string Error)>>(
            TempData["ImportFailures"]!.ToString()!)
        : null;
    var successCount = TempData["ImportSuccess"] as int? ?? 0;
}

<h2>Import Movies from Excel</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger">
                        @TempData["Error"]
                    </div>
                }

                @if (successCount > 0 || (importFailures?.Any() ?? false))
                {
                    <div class="alert @(importFailures?.Any() ?? false ? "alert-warning" : "alert-success")">
                        <h5>Import Results:</h5>
                        <p>Successfully imported: @successCount movies</p>
                        
                        @if (importFailures?.Any() ?? false)
                        {
                            <div>
                                <h6>Failed imports (@importFailures.Count):</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Row</th>
                                                <th>Title</th>
                                                <th>Error</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var failure in importFailures)
                                            {
                                                <tr>
                                                    <td>@failure.RowNumber</td>
                                                    <td>@failure.Title</td>
                                                    <td>@failure.Error</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                }

                <form method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Select Excel File</label>
                        <input type="file" name="file" class="form-control-file" required accept=".xlsx" />
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Import</button>
                        <a asp-action="Index" class="btn btn-secondary">Back to List</a>
                    </div>
                </form>

                <div class="mt-4">
                    <h5>Excel File Format:</h5>
                    <p>Please ensure your Excel file follows this format:</p>
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>Title</th>
                            <th>Release Date</th>
                            <th>Genre</th>
                            <th>Price</th>
                        </tr>
                        </thead>
                    </table>
                    <small class="text-muted">
                        * First row should contain headers<br />
                        * Dates should be in a valid date format (e.g., MM/dd/yyyy)<br />
                        * Price should be a decimal number<br />
                        * Title is required<br />
                        * Price must be non-negative
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>